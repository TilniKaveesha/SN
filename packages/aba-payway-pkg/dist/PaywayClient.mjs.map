{"version":3,"sources":["../src/PaywayClient.ts"],"sourcesContent":["// packages/aba-payway-pkg/src/PaywayClient.ts\n\nimport { generatePaywayHash } from './utils/security';\nimport { Buffer } from 'buffer'; // Node.js Buffer for Base64\n\n// --- HELPER FUNCTIONS ---\n\n// Function to safely perform Base64 encoding\nconst base64Encode = (data: string): string => {\n  return Buffer.from(data, 'utf8').toString('base64');\n};\n\n// Function to format time to YYYYMMDDHHmmss (14 digits)\nconst formatReqTime = (): string => {\n    const now = new Date();\n    const pad = (n: number) => String(n).padStart(2, '0');\n    return (\n        now.getFullYear().toString() +\n        pad(now.getMonth() + 1) + \n        pad(now.getDate()) +\n        pad(now.getHours()) +\n        pad(now.getMinutes()) +\n        pad(now.getSeconds())\n    );\n};\n\n// --- CONFIGURATION & INTERFACES ---\n\nconst API_BASE_URL = 'https://checkout-sandbox.payway.com.kh/api/payment-gateway/v1';\n\ninterface ClientConfig {\n    merchantId: string;\n    apiKey: string;\n    secretKey: string; // Used only for configuration/storage, not hashing\n}\n\ninterface QrItem {\n    name: string;\n    quantity: number;\n    price: number;\n}\n\n// Interface representing the final payload sent to ABA Payway\ninterface QrRequest {\n    merchant_id: string;\n    tran_id: string;\n    currency: 'USD' | 'KHR';    \n    amount: number;    \n    req_time: string; // YYYYMMDDHHmmss\n    payment_method: 'abakhqr';\n    payment_option: 'abapay_khqr';\n    \n    items: string; // Base64 encoded JSON string\n    callback_url: string; // Base64 encoded URL string\n    \n    return_url: string; // Plain string URL\n    remark?: string;\n    hash: string; // Calculated hash\n}\n\n// --- PAYWAY CLIENT CLASS ---\n\nexport class PaywayClient {\n    private merchantId: string;\n    private apiKey: string;\n    private secretKey: string; // Kept for constructor consistency\n\n    constructor(config: ClientConfig) {\n        this.merchantId = config.merchantId;\n        this.apiKey = config.apiKey;\n        this.secretKey = config.secretKey;\n    }\n\n    /**\n     * Generates a dynamic QR code for payment.\n     */\n    public async createQrTransaction(orderDetails: {\n        tran_id: string;\n        currency: 'USD' | 'KHR';\n        amount: number;\n        items: QrItem[]; // Accepts the QrItem array\n        remark?: string;\n        callback_url: string; // Accepts plain string URL\n        return_url: string;   // Accepts plain string URL\n    }) {\n\n\n        \n        \n\n        // 1. Prepare Encoded Strings and Time\n        const formattedItems = orderDetails.items.map(item => ({\n            name: item.name,\n            quantity: item.quantity,\n            // FIX: Format price to a string with exactly two decimal places\n            price: item.price.toFixed(2), \n        }));\n\n        // 2. Base64 Encode the JSON string of the formatted items\n        const encodedItems = base64Encode(JSON.stringify(formattedItems));\n\n        \n\n        const encodedCallbackUrl = base64Encode(orderDetails.callback_url);\n        const req_time = formatReqTime();\n        \n        // CRITICAL FIX: Format Amount to 2 decimal places (must be a string for hashing)\n        const formattedAmount = orderDetails.amount;//.toFixed(2);\n        \n        // Shipping cost is assumed to be an empty string based on the minimal PHP example\n        const shippingCostString = ''; \n\n\n        // 2. Build the HASHING INPUT STRING (CRITICAL)\n        // Order must be: MerchantID + TranID + Amount + Items(Base64) + ShippingCost\n        const hashInputString = \n            this.merchantId +          // 1. Merchant ID\n            orderDetails.tran_id +     // 2. Transaction ID\n            formattedAmount +          // 3. Amount (e.g., \"5.50\")\n            encodedItems;// +             // 4. Base64 Items\n            //orderDetails.currency+\n            //req_time+\n            //'abakhqr'+\n            //'abapay_khqr'+\n           // encodedCallbackUrl+\n           // orderDetails.return_url+\n            //orderDetails.remark;        // 5. Shipping Cost ('')\n\n         \n        // 3. Generate the Signature Hash\n        // NOTE: Uses the hashInputString and the API Key (this.apiKey)\n        const signatureHash = generatePaywayHash(hashInputString, this.apiKey);\n       \n        //throw new Error(this.apiKey);\n        \n        // 4. Build the Final Request Body\n        const finalRequestBody: QrRequest = {\n            merchant_id: this.merchantId,\n            tran_id: orderDetails.tran_id,\n            amount: formattedAmount, // Send as native number/float in JSON\n            items: encodedItems,             \n            currency: orderDetails.currency,\n            req_time: req_time,\n            payment_method: 'abakhqr',\n            payment_option: 'abapay_khqr',           \n            \n            callback_url: encodedCallbackUrl, \n            return_url: orderDetails.return_url,\n            \n            // Conditionally add remark if provided\n            ...(orderDetails.remark && { remark: orderDetails.remark }),\n\n            // Final hash field\n            hash: signatureHash, \n        };\n\n         \n\n        // 5. Execute the Fetch Request\n        try {\n\n\n            const response = await fetch(`${API_BASE_URL}/payments/purchase`, { \n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify(finalRequestBody),\n            });\n            \n            const htmlContent = await response.text();\n            console.log(response);\n            if (!response.ok) {\n                // Attach detailed error body for debugging\n                const errorBody = await response.json().catch(() => ({ \n                    message: 'Failed to parse Payway error response body.' \n                }));\n                const errorMessage = `Payway API error (Status: ${response.status}): ${errorBody}`;\n                throw new Error(errorMessage);\n            }\n\n            return htmlContent;\n        } catch (error) {\n            console.error('Error creating QR transaction:', error);\n            // Re-throw the error so the Next.js Route Handler can handle it\n            throw error; \n        }\n    }\n\n    // NOTE: checkTransaction method would also need to be updated with the\n    // correct hash generation logic and API endpoint if it's part of the new gateway.\n    public async checkTransaction(tranId: string) {\n        // ... (Implementation for checkTransaction goes here, following the same hashing principles)\n        throw new Error(\"CheckTransaction method needs dedicated implementation updates for the new gateway endpoint.\");\n    }\n}"],"mappings":";;;;;AAGA,SAAS,cAAc;AAKvB,IAAM,eAAe,CAAC,SAAyB;AAC7C,SAAO,OAAO,KAAK,MAAM,MAAM,EAAE,SAAS,QAAQ;AACpD;AAGA,IAAM,gBAAgB,MAAc;AAChC,QAAM,MAAM,oBAAI,KAAK;AACrB,QAAM,MAAM,CAAC,MAAc,OAAO,CAAC,EAAE,SAAS,GAAG,GAAG;AACpD,SACI,IAAI,YAAY,EAAE,SAAS,IAC3B,IAAI,IAAI,SAAS,IAAI,CAAC,IACtB,IAAI,IAAI,QAAQ,CAAC,IACjB,IAAI,IAAI,SAAS,CAAC,IAClB,IAAI,IAAI,WAAW,CAAC,IACpB,IAAI,IAAI,WAAW,CAAC;AAE5B;AAIA,IAAM,eAAe;AAkCd,IAAM,eAAN,MAAmB;AAAA,EACd;AAAA,EACA;AAAA,EACA;AAAA;AAAA,EAER,YAAY,QAAsB;AAC9B,SAAK,aAAa,OAAO;AACzB,SAAK,SAAS,OAAO;AACrB,SAAK,YAAY,OAAO;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAa,oBAAoB,cAQ9B;AAOC,UAAM,iBAAiB,aAAa,MAAM,IAAI,WAAS;AAAA,MACnD,MAAM,KAAK;AAAA,MACX,UAAU,KAAK;AAAA;AAAA,MAEf,OAAO,KAAK,MAAM,QAAQ,CAAC;AAAA,IAC/B,EAAE;AAGF,UAAM,eAAe,aAAa,KAAK,UAAU,cAAc,CAAC;AAIhE,UAAM,qBAAqB,aAAa,aAAa,YAAY;AACjE,UAAM,WAAW,cAAc;AAG/B,UAAM,kBAAkB,aAAa;AAGrC,UAAM,qBAAqB;AAK3B,UAAM,kBACF,KAAK;AAAA,IACL,aAAa;AAAA,IACb;AAAA,IACA;AAYJ,UAAM,gBAAgB,mBAAmB,iBAAiB,KAAK,MAAM;AAKrE,UAAM,mBAA8B;AAAA,MAChC,aAAa,KAAK;AAAA,MAClB,SAAS,aAAa;AAAA,MACtB,QAAQ;AAAA;AAAA,MACR,OAAO;AAAA,MACP,UAAU,aAAa;AAAA,MACvB;AAAA,MACA,gBAAgB;AAAA,MAChB,gBAAgB;AAAA,MAEhB,cAAc;AAAA,MACd,YAAY,aAAa;AAAA;AAAA,MAGzB,GAAI,aAAa,UAAU,EAAE,QAAQ,aAAa,OAAO;AAAA;AAAA,MAGzD,MAAM;AAAA,IACV;AAKA,QAAI;AAGA,YAAM,WAAW,MAAM,MAAM,GAAG,YAAY,sBAAsB;AAAA,QAC9D,QAAQ;AAAA,QACR,SAAS;AAAA,UACL,gBAAgB;AAAA,QACpB;AAAA,QACA,MAAM,KAAK,UAAU,gBAAgB;AAAA,MACzC,CAAC;AAED,YAAM,cAAc,MAAM,SAAS,KAAK;AACxC,cAAQ,IAAI,QAAQ;AACpB,UAAI,CAAC,SAAS,IAAI;AAEd,cAAM,YAAY,MAAM,SAAS,KAAK,EAAE,MAAM,OAAO;AAAA,UACjD,SAAS;AAAA,QACb,EAAE;AACF,cAAM,eAAe,6BAA6B,SAAS,MAAM,MAAM,SAAS;AAChF,cAAM,IAAI,MAAM,YAAY;AAAA,MAChC;AAEA,aAAO;AAAA,IACX,SAAS,OAAO;AACZ,cAAQ,MAAM,kCAAkC,KAAK;AAErD,YAAM;AAAA,IACV;AAAA,EACJ;AAAA;AAAA;AAAA,EAIA,MAAa,iBAAiB,QAAgB;AAE1C,UAAM,IAAI,MAAM,8FAA8F;AAAA,EAClH;AACJ;","names":[]}